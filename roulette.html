<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AR Roulette + Lottie</title>
  <style>
    body { margin: 0; overflow: hidden; }
    
    /* Слой для конфетти (поверх всего) */
    #lottie-container {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      z-index: 2000; /* Самый верхний слой */
      pointer-events: none; /* Чтобы сквозь него можно было нажимать кнопки */
      display: none; /* Скрыто по умолчанию */
    }

    #bottom-ui {
      position: fixed; bottom: 30px; left: 0; width: 100%;
      text-align: center; z-index: 1000; font-family: sans-serif;
    }
    
    button {
      padding: 15px 30px; font-size: 20px; border-radius: 40px;
      border: none; background: #ff0055; color: white; font-weight: bold;
      box-shadow: 0 4px 10px rgba(0,0,0,0.5); cursor: pointer;
    }
    button:active { transform: scale(0.95); }

    #debug-console {
      position: fixed; top: 0; left: 0; background: rgba(0,0,0,0.5); 
      color: #00ff00; padding: 10px; z-index: 9999; 
      font-family: monospace; font-size: 14px; pointer-events: none;
    }
  </style>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>

  <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
        "mindar-face-three": "https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-face-three.prod.js"
      }
    }
  </script>

  <script type="module">
    import * as THREE from 'three';
    import { MindARThree } from 'mindar-face-three';
    import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

    function log(msg) {
        const el = document.getElementById('debug-console');
        if(el) el.innerHTML = msg + "<br>" + el.innerHTML;
    }

    // --- НАСТРОЙКА LOTTIE (КОНФЕТТИ) ---
    let lottieAnim = null;

    // Эта функция запустится, когда страница загрузится
    window.initLottie = () => {
        lottieAnim = lottie.loadAnimation({
            container: document.getElementById('lottie-container'), // Куда вставлять
            renderer: 'svg',
            loop: true,     // Зациклить? (true/false)
            autoplay: false, // Не запускать сразу
            path: './confetti.json' // Путь к твоему JSON файлу
        });
        log("Lottie готов");
    };

    const start = async () => {
      // Инициализируем Lottie
      window.initLottie();

      try {
        const mindarThree = new MindARThree({
          container: document.querySelector("#container"),
        });
        const { renderer, scene, camera } = mindarThree;

        const light = new THREE.HemisphereLight(0xffffff, 0xbbbbff, 2);
        scene.add(light);

        const anchor = mindarThree.addAnchor(1);

        // MASK OCCLUDER
        const faceMesh = mindarThree.addFaceMesh();
        faceMesh.material = new THREE.MeshBasicMaterial({ colorWrite: false });
        faceMesh.renderOrder = 0;
        anchor.group.add(faceMesh);

        // --- ЗАГРУЗКА ИКОНОК ---
        const textureLoader = new THREE.TextureLoader();
        const iconPaths = ['./icon1.png', './icon2.png', './icon3.png', './icon4.png'];
        const iconMeshes = [];
        const contentGroup = new THREE.Group();
        contentGroup.position.set(0, 0.8, -0.1); 
        anchor.group.add(contentGroup);

        iconPaths.forEach((path, index) => {
            textureLoader.load(path, (tex) => {
                const geo = new THREE.PlaneGeometry(0.6, 0.6);
                const mat = new THREE.MeshBasicMaterial({ map: tex, transparent: true });
                const mesh = new THREE.Mesh(geo, mat);
                mesh.visible = (index === 0);
                mesh.renderOrder = 2;
                contentGroup.add(mesh);
                iconMeshes[index] = mesh;
                log(`Картинка ${index+1} готова`);
            });
        });

        // --- ЛОГИКА АНИМАЦИИ ---
        let isRunning = false;
        let startTime = 0;
        let lastSwitchTime = 0;
        let currentImageIndex = 0;
        const switchSpeed = 0.1;
        const totalDuration = 3.0; 

        window.startRoulette = () => {
            if (isRunning) return;
            log("Старт рулетки!");
            isRunning = true;
            startTime = new Date().getTime() / 1000;
            document.getElementById('btn').style.display = 'none';
            
            // Скрываем Lottie при рестарте
            document.getElementById('lottie-container').style.display = 'none';
            if(lottieAnim) lottieAnim.stop();
        };

        await mindarThree.start();

        renderer.setAnimationLoop(() => {
            const now = new Date().getTime() / 1000;

            if (isRunning) {
                // Если время вышло (ПОБЕДА)
                if (now - startTime > totalDuration) {
                    isRunning = false;
                    log("Финиш!");

                    // Оставляем только 4-ю картинку
                    iconMeshes.forEach(m => { if(m) m.visible = false; });
                    if (iconMeshes[3]) iconMeshes[3].visible = true;

                    // --- ЗАПУСК LOTTIE ---
                    const lottieDiv = document.getElementById('lottie-container');
                    lottieDiv.style.display = 'block'; // Показываем слой
                    if(lottieAnim) {
                        lottieAnim.goToAndPlay(0, true); // Играем с начала
                    }
                    // ---------------------

                    setTimeout(() => {
                        document.getElementById('btn').style.display = 'inline-block';
                        document.getElementById('btn').innerText = "Еще раз";
                    }, 2000);

                } else {
                    // Крутим рулетку
                    if (now - lastSwitchTime > switchSpeed) {
                        lastSwitchTime = now;
                        if (iconMeshes[currentImageIndex]) iconMeshes[currentImageIndex].visible = false;
                        currentImageIndex = (currentImageIndex + 1) % 4;
                        if (iconMeshes[currentImageIndex]) iconMeshes[currentImageIndex].visible = true;
                    }
                }
            }
            renderer.render(scene, camera);
        });

      } catch (e) {
        log("CRASH: " + e);
      }
    }
    start();
  </script>
</head>
<body>
  <div id="debug-console">Готов...<br></div>
  
  <div id="lottie-container"></div>

  <div id="container" style="width: 100vw; height: 100vh;"></div>
  
  <div id="bottom-ui">
    <button id="btn" onclick="startRoulette()">КРУТИТЬ</button>
  </div>
</body>
</html>
