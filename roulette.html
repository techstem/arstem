<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>WebAR Final Shot Fix</title>
  <style>
    body { margin: 0; overflow: hidden; }

    /* Оверлей рамка */
    #screen-border {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background-image: url('./screen_border.png');
      background-size: 100% 100%; background-repeat: no-repeat;
      pointer-events: none; z-index: 999;
    }
    
    /* Конфетти Lottie */
    #lottie-container {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      z-index: 2000; pointer-events: none; display: none; 
    }

    /* --- ИНТЕРФЕЙС --- */
    #capture-btn {
      position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
      width: 70px; height: 70px; background: white; border: 4px solid #ccc;
      border-radius: 50%; z-index: 3000; cursor: pointer; display: none;
      -webkit-tap-highlight-color: transparent;
    }
    #capture-btn:active { transform: translateX(-50%) scale(0.95); background: #eee; }
    #capture-btn::after {
        content: ''; position: absolute; top: 50%; left: 50%;
        transform: translate(-50%, -50%); width: 50px; height: 50px;
        background: #ff0055; border-radius: 50%;
    }

    #switch-btn {
      position: fixed; top: 20px; right: 20px; width: 50px; height: 50px;
      background: rgba(0,0,0,0.5); border-radius: 50%; border: 1px solid white;
      z-index: 3000; display: flex; justify-content: center; align-items: center;
      cursor: pointer; -webkit-tap-highlight-color: transparent;
    }
    #switch-btn svg { width: 30px; height: 30px; fill: white; }

    #action-btn {
      position: fixed; bottom: 120px; left: 50%; transform: translateX(-50%);
      padding: 12px 30px; font-size: 18px; border-radius: 40px;
      border: none; background: #ff0055; color: white; font-weight: bold;
      box-shadow: 0 4px 10px rgba(0,0,0,0.5); cursor: pointer; z-index: 3001;
      -webkit-tap-highlight-color: transparent;
    }

    #debug-console {
      position: fixed; top: 0; left: 0; background: rgba(0,0,0,0.5); 
      color: #00ff00; padding: 5px; z-index: 9999; 
      font-family: monospace; font-size: 10px; pointer-events: none;
    }

    /* Вспышка (медленная) */
    .flash-effect {
        position: fixed; top:0; left:0; width:100%; height:100%;
        background: white; z-index: 9999; opacity: 1;
        transition: opacity 0.8s ease-out;
    }
  </style>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>

  <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
        "mindar-face-three": "https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-face-three.prod.js"
      }
    }
  </script>

  <script type="module">
    import * as THREE from 'three';
    import { MindARThree } from 'mindar-face-three';

    function log(msg) {
        const el = document.getElementById('debug-console');
        if(el) el.innerHTML = msg + "<br>" + el.innerHTML;
        console.log(msg);
    }

    const borderOverlayImage = new Image();
    borderOverlayImage.src = './screen_border.png';
    borderOverlayImage.crossOrigin = "anonymous";

    // --- ИСПРАВЛЕННАЯ ФУНКЦИЯ ФОТО (Добавлены scene и camera) ---
    async function captureAndShare(mindarThree, scene, camera) {
        const video = mindarThree.video;
        const renderer = mindarThree.renderer;
        
        const canvas = document.createElement("canvas");
        canvas.width = window.innerWidth * window.devicePixelRatio;
        canvas.height = window.innerHeight * window.devicePixelRatio;
        const ctx = canvas.getContext("2d");

        // Слой A: Видео
        const videoAspect = video.videoWidth / video.videoHeight;
        const canvasAspect = canvas.width / canvas.height;
        let drawW, drawH, startX, startY;
        if (canvasAspect > videoAspect) {
            drawW = canvas.width; drawH = canvas.width / videoAspect;
            startX = 0; startY = (canvas.height - drawH) / 2;
        } else {
            drawW = canvas.height * videoAspect; drawH = canvas.height;
            startX = (canvas.width - drawW) / 2; startY = 0;
        }
        ctx.save();
        ctx.translate(canvas.width, 0); ctx.scale(-1, 1);
        ctx.drawImage(video, -startX, startY, drawW, drawH); 
        ctx.restore();

        // Слой B: 3D AR (КРИТИЧЕСКОЕ ИСПРАВЛЕНИЕ!)
        // Принудительно рендерим сцену прямо сейчас, чтобы буфер был свежим
        renderer.render(scene, camera);
        // Теперь рисуем WebGL холст
        ctx.drawImage(renderer.domElement, 0, 0, canvas.width, canvas.height);

        // Слой C: Оверлей рамка
        if (borderOverlayImage.complete) {
             ctx.drawImage(borderOverlayImage, 0, 0, canvas.width, canvas.height);
        }

        // Шеринг
        canvas.toBlob(async (blob) => {
            const file = new File([blob], "ar-photo.png", { type: "image/png" });
            if (navigator.canShare && navigator.canShare({ files: [file] })) {
                try {
                    await navigator.share({
                        files: [file], title: 'Мой AR образ', text: 'Смотри, что получилось!'
                    });
                } catch (error) { log("Шеринг отменен: " + error); }
            } else {
                const link = document.createElement("a");
                link.download = "ar-photo.png";
                link.href = canvas.toDataURL("image/png");
                link.click();
            }
        }, 'image/png');
    }

    // LOTTIE
    let lottieAnim = null;
    window.initLottie = () => {
        lottieAnim = lottie.loadAnimation({
            container: document.getElementById('lottie-container'), 
            renderer: 'svg', loop: false, autoplay: false, path: './confetti.json' 
        });
    };

    const start = async () => {
      window.initLottie();

      try {
        const mindarThree = new MindARThree({
          container: document.querySelector("#container"),
        });
        // Получаем scene и camera здесь, они нужны для фото
        const { renderer, scene, camera } = mindarThree;
        
        renderer.preserveDrawingBuffer = true; // На всякий случай оставляем

        const light = new THREE.HemisphereLight(0xffffff, 0xbbbbff, 2);
        scene.add(light);
        const anchor = mindarThree.addAnchor(1);

        // Маска-невидимка
        const faceMesh = mindarThree.addFaceMesh();
        faceMesh.material = new THREE.MeshBasicMaterial({ colorWrite: false });
        faceMesh.renderOrder = 0;
        anchor.group.add(faceMesh);

        // Картинки рулетки
        const textureLoader = new THREE.TextureLoader();
        const iconPaths = ['./icon1.png', './icon2.png', './icon3.png', './icon4.png'];
        const iconMeshes = [];
        const contentGroup = new THREE.Group();
        contentGroup.position.set(0, 0.8, -0.1); 
        anchor.group.add(contentGroup);

        iconPaths.forEach((path, index) => {
            textureLoader.load(path, (tex) => {
                tex.minFilter = THREE.LinearFilter; tex.magFilter = THREE.LinearFilter;
                tex.colorSpace = THREE.SRGBColorSpace;
                const geo = new THREE.PlaneGeometry(0.6, 0.6); 
                const mat = new THREE.MeshBasicMaterial({ map: tex, transparent: true });
                const mesh = new THREE.Mesh(geo, mat);
                mesh.visible = (index === 0);
                mesh.renderOrder = 2;
                contentGroup.add(mesh);
                iconMeshes[index] = mesh;
            });
        });

        // ЛОГИКА
        let isRunning = false;
        let startTime = 0;
        let lastSwitchTime = 0;
        let currentImageIndex = 0;
        const switchSpeed = 0.1;
        const totalDuration = 3.0; 

        window.startRoulette = () => {
            if (isRunning) return;
            isRunning = true;
            startTime = new Date().getTime() / 1000;
            document.getElementById('action-btn').style.display = 'none';
            document.getElementById('capture-btn').style.display = 'block';
            document.getElementById('lottie-container').style.display = 'none';
            if(lottieAnim) lottieAnim.stop();
        };

        // КНОПКА ФОТО (Передаем scene и camera)
        window.takeSnap = () => {
            // <-- ВАЖНОЕ ИЗМЕНЕНИЕ ЗДЕСЬ
            captureAndShare(mindarThree, scene, camera);
            
            const flash = document.createElement('div');
            flash.className = 'flash-effect';
            document.body.appendChild(flash);
            setTimeout(() => { flash.style.opacity='0'; }, 200);
            setTimeout(() => { flash.remove(); }, 1000);
        };

        window.switchCam = () => { mindarThree.switchCamera(); };

        await mindarThree.start();
        document.getElementById('capture-btn').style.display = 'block';

        renderer.setAnimationLoop(() => {
            const now = new Date().getTime() / 1000;
            if (isRunning) {
                if (now - startTime > totalDuration) {
                    isRunning = false;
                    iconMeshes.forEach(m => { if(m) m.visible = false; });
                    if (iconMeshes[3]) iconMeshes[3].visible = true;
                    const lottieDiv = document.getElementById('lottie-container');
                    lottieDiv.style.display = 'block'; 
                    if(lottieAnim) lottieAnim.goToAndPlay(0, true);
                    setTimeout(() => {
                        const btn = document.getElementById('action-btn');
                        btn.style.display = 'inline-block';
                        btn.innerText = "Еще раз";
                    }, 2000);
                } else {
                    if (now - lastSwitchTime > switchSpeed) {
                        lastSwitchTime = now;
                        if (iconMeshes[currentImageIndex]) iconMeshes[currentImageIndex].visible = false;
                        currentImageIndex = (currentImageIndex + 1) % 4;
                        if (iconMeshes[currentImageIndex]) iconMeshes[currentImageIndex].visible = true;
                    }
                }
            }
            renderer.render(scene, camera);
        });

      } catch (e) { log("CRASH: " + e); }
    }
    start();
  </script>
</head>
<body>
  <div id="debug-console"></div>
  <div id="screen-border"></div>
  <div id="lottie-container"></div>
  <div id="container" style="width: 100vw; height: 100vh;"></div>
  <div id="switch-btn" onclick="switchCam()">
    <svg viewBox="0 0 24 24"><path d="M20 4h-3.17L15 2H9L7.17 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm-5 11.5V13H9v2.5L5.5 12 9 8.5V11h6V8.5l3.5 3.5-3.5 3.5z"/></svg>
  </div>
  <button id="action-btn" onclick="startRoulette()">КРУТИТЬ</button>
  <div id="capture-btn" onclick="takeSnap()"></div>
</body>
</html>
